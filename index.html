<!doctype html>
<html lang="pt-BR">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Controle de Tráfego</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* TODO: SEU CSS INTEIRO VAI AQUI... */
    /* (Ocultado para brevidade, pois não foi alterado) */
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #253d70 0%, #1e2a54 100%);
      min-height: 100%;
      padding: 2rem 1rem;
    }

    * {
      box-sizing: border-box;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .login-container {
      max-width: 450px;
      margin: 0 auto;
      margin-top: 8%;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 2rem;
      position: relative;
    }

    .header h1 {
      font-size: 2rem;
      font-weight: 700;
      margin: 0 0 0.5rem 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1rem;
    }

    .header .logo-icon {
      width: 40px;
      height: 40px;
      fill: white;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .header p {
      font-size: 1rem;
      opacity: 0.9;
      margin: 0;
    }

    .header-with-weather {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 2rem;
      align-items: start;
      max-width: 1200px;
      margin: 0 auto 2rem auto;
    }

    .header-content {
      text-align: center;
      color: white;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      margin-bottom: 2rem;
    }

    .login-card {
      background: linear-gradient(163deg, #00ff75 0%, #3700ff 100%);
      border-radius: 22px;
      transition: all 0.3s;
      padding: 0;
      overflow: hidden;
    }

    .login-card:hover {
      box-shadow: 0px 0px 30px 1px rgba(0, 255, 117, 0.3);
    }

    .login-card-inner {
      background: #ffffff;
      border-radius: 20px;
      padding: 2rem;
      margin: 5px;
      transition: all 0.2s;
    }

    .login-card-inner:hover {
      transform: scale(0.98);
    }

    .login-card h2 {
      color: #1e293b;
      margin: 2rem 0;
      font-size: 1.2rem;
      font-weight: 700;
      text-align: center;
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid #e5e7eb;
      margin-bottom: 2rem;
      margin-left: -1.5rem;
      margin-right: -1.5rem;
    }

    .tab-btn {
      flex: 1;
      padding: 1rem;
      border: none;
      background: transparent;
      color: #6b7280;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      border-bottom: 2px solid transparent;
    }

    .tab-btn:hover {
      color: #374151;
      background: #f9fafb;
    }

    .tab-btn.active {
      color: #253d70;
      border-bottom-color: #253d70;
      background: #f8faff;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .sync-status {
      background: #f0f9ff;
      border: 1px solid #0ea5e9;
      border-radius: 8px;
      padding: 0.75rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
      display: none;
    }

    .sync-status.show {
      display: block;
    }

    .sync-status.syncing {
      background: #fef3c7;
      border-color: #f59e0b;
    }

    .sync-status.success {
      background: #f0fdf4;
      border-color: #22c55e;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      text-align: left;
    }

    .form-group label {
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }

    .form-group input, .form-group textarea {
      padding: 0.75rem;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.2s;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-group input:focus, .form-group textarea:focus {
      outline: none;
      border-color: #253d70;
      box-shadow: 0 0 0 3px rgba(37, 61, 112, 0.1);
    }

    .field {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5em;
      background-color: #f8fafc;
      border-radius: 25px;
      padding: 0.6em;
      border: 2px solid #e2e8f0;
      outline: none;
      transition: all 0.3s;
      margin-bottom: 1rem;
    }

    .field:focus-within {
      border-color: #00ff75;
      box-shadow: 0 0 0 3px rgba(0, 255, 117, 0.1);
      background-color: #ffffff;
    }

    .input-icon {
      height: 1.3em;
      width: 1.3em;
      fill: #64748b;
      flex-shrink: 0;
    }

    .input-field {
      background: none;
      border: none;
      outline: none;
      width: 100%;
      color: #1e293b;
      font-size: 1rem;
      padding: 0.5rem;
    }

    .input-field::placeholder {
      color: #94a3b8;
    }

    .form-group input:disabled {
      background-color: #f9fafb;
      color: #6b7280;
    }

    .form-group small {
      color: #6b7280;
      font-size: 0.75rem;
      margin-top: 0.25rem;
      display: block;
    }

    .button-group {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .btn {
      flex: 1;
      min-width: 200px;
      padding: 0.875rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: #253d70;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #1e2a54;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 61, 112, 0.4);
    }

    .btn-secondary {
      background: #10b981;
      color: white;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #059669;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover:not(:disabled) {
      background: #dc2626;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }

    .btn-logout {
      background: #6b7280;
      color: white;
      min-width: auto;
      flex: none;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    .btn-logout:hover:not(:disabled) {
      background: #4b5563;
    }

    .user-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding: 1rem;
      background: #f9fafb;
      border-radius: 8px;
    }

    .user-info span {
      color: #374151;
      font-weight: 600;
    }

    .user-details {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .user-details .location {
      font-size: 0.875rem;
      color: #6b7280;
      font-weight: normal;
    }

    .manager-profile {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    /* Manager Card Styles */
    .manager-card-container {
      display: flex;
      justify-content: center;
      margin-bottom: 2rem;
    }

    .manager-card {
      position: relative;
      width: 190px;
      height: 254px;
      background: linear-gradient(-45deg, #161616 0%, #000000 100%);
      color: #81818144;
      display: flex;
      flex-direction: column;
      justify-content: end;
      padding: 14px;
      gap: 10px;
      border-radius: 8px;
      cursor: pointer;
    }

    .manager-card::before {
      content: "";
      position: absolute;
      inset: 0;
      left: 0;
      margin: auto;
      width: 190px;
      height: 260px;
      border-radius: 10px;
      background: linear-gradient(-45deg, #253d70 0%, #1e2a54 40%);
      z-index: -10;
      pointer-events: none;
      transition: all 0.8s cubic-bezier(0.175, 0.95, 0.9, 1.275);
      box-shadow: 0px 20px 30px hsla(0, 0%, 0%, 0.521);
    }

    .manager-card::after {
      content: "";
      z-index: -1;
      position: absolute;
      inset: 0;
      width: 165px;
      height: 245px;
      background: linear-gradient(-45deg, #2d4a7c 0%, #253d70 100%);
      transform: translate3d(0, 0, 0) scale(0.45);
    }

    .manager-card .heading {
      font-size: 20px;
      text-transform: capitalize;
      font-weight: 900;
      color: white;
    }

    .manager-card p:not(.heading) {
      font-size: 14px;
      color: #cbd5e1;
    }

    .manager-card p:last-child {
      color: #60a5fa;
      font-weight: 900;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .manager-card:hover::after {
      transition: all 0.2s cubic-bezier(0.175, 0.285, 0.82, 1.275);
    }

    .manager-card:hover::before {
      transform: scaleX(1.02) scaleY(1.02);
      box-shadow: 0px 0px 30px 0px hsla(220, 50%, 50%, 0.5);
    }

    .profile-photo-container {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .profile-photo {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #253d70 0%, #1e2a54 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      overflow: hidden;
      border: 3px solid white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .profile-photo:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    .profile-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    .photo-upload-btn {
      position: absolute;
      bottom: -2px;
      right: -2px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #10b981;
      border: 2px solid white;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      font-size: 0;
    }

    .photo-upload-btn:hover {
      background: #059669;
      transform: scale(1.1);
    }

    .photo-upload-btn svg {
      width: 12px;
      height: 12px;
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .table-header h2 {
      font-size: 1.5rem;
      color: #374151;
      margin: 0;
    }

    .table-actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .table-actions .btn {
      min-width: auto;
      flex: none;
    }

    .table-container {
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    thead {
      background: #f9fafb;
    }

    th {
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      color: #374151;
      font-size: 0.875rem;
      border-bottom: 2px solid #e5e7eb;
      white-space: nowrap;
    }

    td {
      padding: 1rem;
      border-bottom: 1px solid #e5e7eb;
      color: #6b7280;
      font-size: 0.875rem;
    }

    tbody tr:hover {
      background: #f9fafb;
    }

    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status-pendente {
      background: #fef3c7;
      color: #92400e;
    }

    .status-enviado {
      background: #d1fae5;
      color: #065f46;
    }

    .status-erro {
      background: #fee2e2;
      color: #991b1b;
    }

    .module-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .module-manual {
      background: #ddd6fe;
      color: #5b21b6;
    }

    .checkbox-cell {
      width: 40px;
      text-align: center;
    }

    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #9ca3af;
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin: 0 auto 1rem;
      opacity: 0.5;
    }

    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: white;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast.success {
      border-left: 4px solid #10b981;
    }

    .toast.error {
      border-left: 4px solid #ef4444;
    }

    .spinner {
      border: 2px solid #f3f4f6;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .hidden {
      display: none !important;
    }

    /* Dashboard Styles */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .dashboard-card {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border-radius: 12px;
      padding: 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      border: 1px solid #e2e8f0;
      transition: all 0.2s;
    }

    .dashboard-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .dashboard-icon {
      background: white;
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .dashboard-content h3 {
      font-size: 2rem;
      font-weight: 700;
      color: #1e293b;
      margin: 0 0 0.25rem 0;
    }

    .dashboard-content p {
      font-size: 0.875rem;
      color: #64748b;
      margin: 0;
      font-weight: 500;
    }

    /* Ranking Styles */
    .ranking-container {
      background: #f8fafc;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #e2e8f0;
    }

    .ranking-item {
      display: grid;
      grid-template-columns: 60px 1fr 150px 120px 80px 120px;
      gap: 1rem;
      padding: 1rem;
      align-items: center;
      border-bottom: 1px solid #e2e8f0;
    }

    .ranking-item:last-child {
      border-bottom: none;
    }

    .ranking-header {
      background: #1e293b;
      color: white;
      font-weight: 600;
      font-size: 0.875rem;
    }

    .ranking-item:not(.ranking-header):hover {
      background: white;
    }

    .ranking-position {
      font-weight: 700;
      font-size: 1.25rem;
      text-align: center;
    }

    .ranking-position.gold {
      color: #f59e0b;
    }

    .ranking-position.silver {
      color: #6b7280;
    }

    .ranking-position.bronze {
      color: #d97706;
    }

    .ranking-driver {
      font-weight: 600;
      color: #1e293b;
    }

    .ranking-location {
      color: #64748b;
      font-size: 0.875rem;
    }

    .ranking-metric {
      font-weight: 600;
      color: #059669;
    }

    .ranking-reports {
      text-align: center;
      color: #374151;
    }

    .ranking-avg {
      text-align: center;
      color: #6366f1;
      font-weight: 500;
    }

    /* Filter Styles */
    .ranking-filters,
    .table-filters {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .filter-select {
      padding: 0.5rem 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      background: white;
      color: #374151;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-select:focus {
      outline: none;
      border-color: #253d70;
      box-shadow: 0 0 0 3px rgba(37, 61, 112, 0.1);
    }

    .empty-ranking {
      text-align: center;
      padding: 2rem;
      color: #9ca3af;
      grid-column: 1 / -1;
    }

    /* Weather Card Styles */
    .weather-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 140px;
      width: 240px;
      border-radius: 20px;
      background: lightgrey;
      overflow: hidden;
      transition: 100ms ease;
      box-shadow: rgba(0, 0, 0, 0.3) 3px 4px 8px;
    }

    .info-section {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      height: 75%;
      color: white;
    }

    .left-side {
      display: flex;
      flex-direction: column;
      justify-content: space-around;
      height: 100%;
      z-index: 1;
      padding-left: 18px;
    }

    .weather-info {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 5px;
    }

    .weather-info div {
      display: flex;
      align-items: center;
    }

    .weather-info div:nth-child(1) {
      width: 35%;
      height: auto;
    }

    .weather-info svg {
      width: 45px;
      height: 45px;
    }

    .temperature {
      font-size: 28pt;
      font-weight: 500;
      line-height: 8%;
    }

    .right-side {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      justify-content: space-around;
      height: 100%;
      padding-right: 14px;
      z-index: 1;
    }

    .right-side > div {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .hour {
      font-size: 16pt;
      line-height: 1em;
    }

    .date {
      font-size: 12px;
    }

    .background-design {
      position: absolute;
      height: 100%;
      width: 100%;
      background-color: #ec7263;
      overflow: hidden;
    }

    .circle {
      background-color: #efc745;
    }

    .circle:nth-child(1) {
      position: absolute;
      top: -80%;
      right: -50%;
      width: 250px;
      height: 250px;
      opacity: 0.4;
      border-radius: 50%;
    }

    .circle:nth-child(2) {
      position: absolute;
      top: -70%;
      right: -30%;
      width: 180px;
      height: 180px;
      opacity: 0.4;
      border-radius: 50%;
    }

    .circle:nth-child(3) {
      position: absolute;
      top: -35%;
      right: -8%;
      width: 80px;
      height: 80px;
      opacity: 1;
      border-radius: 50%;
    }

    .days-section {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      height: 25%;
      background-color: #974859;
      gap: 2px;
      box-shadow: inset 0px 2px 5px #974859;
    }

    .days-section button {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      width: 100%;
      background-color: #a75265;
      box-shadow: inset 0px 2px 5px #974859;
      cursor: pointer;
      transition: 100ms ease;
      gap: 3px;
      border: none;
    }

    .days-section button:hover {
      scale: 0.9;
      border-radius: 8px;
    }

    .days-section .day {
      font-size: 8pt;
      font-weight: 500;
      color: white;
      opacity: 0.7;
    }

    .icon-weather-day {
      display: flex;
      align-items: center;
      width: 14px;
      height: 100%;
    }

    .icon-weather-day svg {
      width: 14px;
      height: 14px;
    }

    .location-name {
      font-size: 9pt;
      font-weight: 600;
      opacity: 0.9;
    }

    .btn-link {
      background-color: #f1f5f9;
      border: none;
      color: #475569;
      text-decoration: none;
      cursor: pointer;
      font-size: 0.875rem;
      padding: 0.5em;
      margin-bottom: 3em;
      transition: 0.4s ease-in-out;
      border-radius: 5px;
      font-weight: 600;
      display: inline-block;
      width: 100%;
    }

    .btn-link:hover {
      background-color: #ef4444;
      color: white;
    }

    .login-buttons {
      display: flex;
      justify-content: center;
      flex-direction: row;
      gap: 0.5rem;
      margin-top: 2.5rem;
      margin-bottom: 1rem;
    }

    .login-buttons .btn {
      padding: 0.5em 1.1em;
      border-radius: 8px;
      border: none;
      outline: none;
      transition: 0.4s ease-in-out;
      background-color: #253d70;
      color: white;
      font-weight: 600;
    }

    .login-buttons .btn:hover:not(:disabled) {
      background-color: #1e2a54;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 61, 112, 0.4);
    }

    .login-buttons .btn-primary {
      background-color: #253d70;
    }

    .login-buttons .btn-primary:hover:not(:disabled) {
      background-color: #1e2a54;
    }

    .login-buttons .btn-secondary {
      background-color: #10b981;
      padding: 0.5em 2.3em;
    }

    .login-buttons .btn-secondary:hover:not(:disabled) {
      background-color: #059669;
    }

    /* Reports Controls Styles */
    .reports-controls {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .search-filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .export-buttons {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .export-buttons .btn {
      min-width: auto;
      flex: none;
    }

    /* BI Analytics Styles */
    .bi-analytics-section {
      margin-top: 2rem;
    }

    .analytics-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .analytics-controls {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .chart-card {
      min-height: 350px;
      display: flex;
      flex-direction: column;
    }

    .chart-card.full-width {
      grid-column: 1 / -1;
      min-height: 200px;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #e5e7eb;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .chart-header h3 {
      margin: 0;
      color: #1e293b;
      font-size: 1.125rem;
      font-weight: 600;
    }

    .chart-legend {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: #64748b;
    }

    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
    }

    .chart-info {
      font-size: 0.875rem;
      color: #64748b;
      font-weight: 500;
    }

    .chart-container {
      flex: 1;
      position: relative;
      min-height: 250px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chart-container canvas {
      max-width: 100%;
      max-height: 100%;
    }

    /* Heatmap Styles */
    .heatmap-legend {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.75rem;
      color: #64748b;
    }

    .heatmap-scale {
      display: flex;
      gap: 2px;
    }

    .heatmap-cell {
      width: 10px;
      height: 10px;
      border-radius: 2px;
    }

    .heatmap-cell.level-0 { background: #f1f5f9; }
    .heatmap-cell.level-1 { background: #cbd5e1; }
    .heatmap-cell.level-2 { background: #94a3b8; }
    .heatmap-cell.level-3 { background: #64748b; }
    .heatmap-cell.level-4 { background: #334155; }

    .heatmap-container {
      padding: 1rem;
      background: #f8fafc;
      border-radius: 8px;
      overflow-x: auto;
    }

    .heatmap-grid {
      display: grid;
      grid-template-columns: repeat(53, 12px);
      gap: 2px;
      min-width: 700px;
    }

    .heatmap-day {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .heatmap-day:hover {
      transform: scale(1.2);
      border: 1px solid #334155;
    }

    .heatmap-tooltip {
      position: absolute;
      background: #1e293b;
      color: white;
      padding: 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      pointer-events: none;
      z-index: 1000;
      white-space: nowrap;
    }

    /* Performance Metrics */
    .performance-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
    }

    .metric-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
      transition: all 0.2s;
    }

    .metric-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .metric-icon {
      font-size: 1.5rem;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .metric-content {
      flex: 1;
    }

    .metric-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 0.25rem;
    }

    .metric-label {
      font-size: 0.75rem;
      color: #64748b;
      font-weight: 500;
    }

    /* Location Analysis */
    .location-analysis {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .location-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      background: #f8fafc;
      border-radius: 6px;
      border-left: 4px solid #3b82f6;
    }

    .location-name {
      font-weight: 600;
      color: #1e293b;
      font-size: 0.875rem;
    }

    .location-stats {
      display: flex;
      gap: 1rem;
      font-size: 0.75rem;
      color: #64748b;
    }

    .location-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .location-stat-value {
      font-weight: 600;
      color: #1e293b;
      font-size: 0.875rem;
    }

    /* Advanced Analytics */
    .advanced-controls {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .insights-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .insight-card {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      padding: 1.5rem;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border-radius: 12px;
      border: 1px solid #0ea5e9;
      transition: all 0.3s;
    }

    .insight-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(14, 165, 233, 0.15);
    }

    .insight-icon {
      font-size: 2rem;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }

    .insight-content h4 {
      margin: 0 0 0.5rem 0;
      color: #0c4a6e;
      font-size: 1.125rem;
      font-weight: 600;
    }

    .insight-content p {
      margin: 0;
      color: #0369a1;
      font-size: 0.875rem;
      line-height: 1.5;
    }

    .insight-card.warning {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-color: #f59e0b;
    }

    .insight-card.warning .insight-content h4 {
      color: #92400e;
    }

    .insight-card.warning .insight-content p {
      color: #d97706;
    }

    .insight-card.success {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      border-color: #10b981;
    }

    .insight-card.success .insight-content h4 {
      color: #065f46;
    }

    .insight-card.success .insight-content p {
      color: #047857;
    }

    .insight-card.danger {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      border-color: #ef4444;
    }

    .insight-card.danger .insight-content h4 {
      color: #991b1b;
    }

    .insight-card.danger .insight-content p {
      color: #dc2626;
    }

    /* Chart Loading State */
    .chart-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: #64748b;
    }

    .chart-loading .spinner {
      width: 32px;
      height: 32px;
      margin-bottom: 1rem;
    }

    /* Responsive Charts */
    @media (max-width: 768px) {
      .charts-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .chart-card {
        min-height: 300px;
      }

      .analytics-header {
        flex-direction: column;
        align-items: stretch;
      }

      .analytics-controls {
        justify-content: center;
      }

      .performance-metrics {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      }

      .metric-item {
        flex-direction: column;
        text-align: center;
        gap: 0.5rem;
      }

      .heatmap-container {
        padding: 0.5rem;
      }

      .location-stats {
        flex-direction: column;
        gap: 0.5rem;
      }

      .insights-panel {
        grid-template-columns: 1fr;
      }

      .insight-card {
        padding: 1rem;
      }

      .advanced-controls {
        flex-direction: column;
      }
    }

    /* Responsible Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
    }

    .modal {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 0.5rem;
    }

    .modal-subtitle {
      font-size: 0.875rem;
      color: #64748b;
    }

    .route-summary {
      background: #f8fafc;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }

    .route-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }

    .route-item:last-child {
      margin-bottom: 0;
    }

    .route-label {
      color: #64748b;
    }

    .route-value {
      font-weight: 600;
      color: #1e293b;
    }

    @media (max-width: 768px) {
      body {
        padding: 1rem 0.5rem;
      }

      .container {
        padding: 0 0.5rem;
      }

      .login-container {
        margin-top: 4%;
        padding: 0 0.5rem;
      }

      .header h1 {
        font-size: 1.25rem;
        flex-direction: row;
        gap: 0.5rem;
      }

      .header .logo-icon {
        width: 28px;
        height: 28px;
      }

      .header p {
        font-size: 0.875rem;
      }

      .card {
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .login-card {
        padding: 1rem;
      }

      .form-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .button-group {
        flex-direction: column;
        gap: 0.75rem;
      }

      .btn {
        min-width: auto;
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
      }

      .table-header {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
      }

      .table-actions {
        width: 100%;
      }

      .table-actions .btn {
        flex: 1;
        font-size: 0.875rem;
      }

      .user-info {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
        padding: 0.75rem;
      }

      .manager-profile {
        flex-direction: column;
        gap: 0.75rem;
        text-align: center;
      }

      .profile-photo {
        width: 50px;
        height: 50px;
      }

      .dashboard-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
      }

      .dashboard-card {
        padding: 1rem;
        flex-direction: column;
        text-align: center;
        gap: 0.75rem;
      }

      .dashboard-content h3 {
        font-size: 1.5rem;
      }

      .ranking-item {
        grid-template-columns: 30px 1fr 60px 50px;
        gap: 0.5rem;
        font-size: 0.75rem;
        padding: 0.75rem;
      }

      .ranking-location,
      .ranking-avg {
        display: none;
      }

      .ranking-filters,
      .table-filters {
        flex-direction: column;
        gap: 0.75rem;
      }

      .search-filters {
        grid-template-columns: 1fr;
        gap: 0.75rem;
      }

      .export-buttons {
        flex-direction: column;
        gap: 0.75rem;
      }

      .export-buttons .btn {
        width: 100%;
      }

      .reports-controls {
        gap: 1rem;
      }

      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      table {
        min-width: 800px;
      }

      th, td {
        padding: 0.5rem;
        font-size: 0.75rem;
        white-space: nowrap;
      }

      .modal {
        margin: 1rem;
        padding: 1.5rem;
        max-width: calc(100vw - 2rem);
      }

      .modal-title {
        font-size: 1.125rem;
      }

      .route-summary {
        padding: 0.75rem;
      }

      .tabs {
        margin-left: -1rem;
        margin-right: -1rem;
      }

      .tab-btn {
        padding: 0.75rem;
        font-size: 0.875rem;
      }

      .toast {
        bottom: 1rem;
        right: 1rem;
        left: 1rem;
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
      }

      .header-with-weather {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .weather-card {
        margin: 0 auto;
      }
    }

    @media (max-width: 480px) {
      .header h1 {
        font-size: 1.125rem;
      }

      .header .logo-icon {
        width: 24px;
        height: 24px;
      }

      .card {
        padding: 0.75rem;
      }

      .dashboard-grid {
        grid-template-columns: 1fr;
      }

      .ranking-item {
        grid-template-columns: 25px 1fr 50px;
        gap: 0.25rem;
        padding: 0.5rem;
      }

      .ranking-reports {
        display: none;
      }

      .btn {
        padding: 0.625rem 0.875rem;
        font-size: 0.8125rem;
      }

      .form-group label {
        font-size: 0.8125rem;
      }

      .form-group input,
      .form-group textarea,
      .filter-select {
        padding: 0.625rem;
        font-size: 0.875rem;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body><div id="responsible-modal" class="modal-overlay hidden">
   <div class="modal">
    <div class="modal-header">
     <h3 class="modal-title">Atesto de Responsabilidade</h3>
     <p class="modal-subtitle">Informe o responsável da unidade que atesta as rotas selecionadas:</p>
    </div>
    <div class="form-group"><label for="responsible-name">Nome do Responsável</label> <input type="text" id="responsible-name" required placeholder="Ex: João Silva Santos"> <small>Nome completo do responsável pela unidade</small>
    </div>
    <div class="form-group"><label for="unit-type">Tipo de Unidade</label> <select id="unit-type" required> <option value="">Selecione o tipo de unidade</option> <option value="CRAS">CRAS - Centro de Referência de Assistência Social</option> <option value="CREAS">CREAS - Centro de Referência Especializado de Assistência Social</option> <option value="Conselho Tutelar">Conselho Tutelar</option> <option value="Outra Unidade">Outra Unidade</option> </select>
    </div>
    <div class="route-summary">
     <div class="route-item"><span class="route-label">Registros selecionados:</span> <span class="route-value" id="selected-count">0</span>
     </div>
     <div class="route-item"><span class="route-label">Total de quilometragem:</span> <span class="route-value" id="selected-km">0 km</span>
     </div>
    </div>
    <div class="button-group"><button class="btn btn-secondary" id="confirm-responsible-btn">
      <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5" />
      </svg> Confirmar e Enviar </button> <button class="btn btn-danger" id="cancel-responsible-btn">
      <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12" />
      </svg> Cancelar </button>
    </div>
   </div>
  </div><div id="login-screen" class="login-container">
   <div class="header">
    <h1 id="page-title">
     <svg class="logo-icon" xmlns="http://www.w3.org/2000/svg" height="40" width="40" viewbox="0 0 640 640" fill="white"><path d="M541.9 139.5C546.4 127.7 543.6 114.3 534.7 105.4C525.8 96.5 512.4 93.6 500.6 98.2L84.6 258.2C71.9 263 63.7 275.2 64 288.7C64.3 302.2 73.1 314.1 85.9 318.3L262.7 377.2L321.6 554C325.9 566.8 337.7 575.6 351.2 575.9C364.7 576.2 376.9 568 381.8 555.4L541.8 139.4z" />
     </svg> Sistema de Controle de Tráfego</h1>
    <p id="department-name">COORDENAÇÃO DE SUPORTE E LOGÍSTICA - SEMCAS</p>
   </div>
   <div class="card login-card">
    <div class="login-card-inner"><div class="tabs"><button class="tab-btn active" id="login-tab" onclick="switchTab('login')">
       <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 012 2v14a2 2 0 01-2 2h-4M10 17l5-5-5-5M21 12H9" />
       </svg> Login </button> <button class="tab-btn" id="register-tab" onclick="switchTab('register')">
       <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2M12.5 7a4 4 0 11-8 0 4 4 0 018 0zM20 8v6M23 11h-6" />
       </svg> Cadastrar-se </button>
     </div><div id="login-content" class="tab-content active">
      <h2 id="login-title">Login</h2>
      <form id="login-form">
       <div class="field">
        <svg viewbox="0 0 16 16" fill="currentColor" height="16" width="16" xmlns="http://www.w3.org/2000/svg" class="input-icon"><path d="M13.106 7.222c0-2.967-2.249-5.032-5.482-5.032-3.35 0-5.646 2.318-5.646 5.702 0 3.493 2.235 5.708 5.762 5.708.862 0 1.689-.123 2.304-.335v-.862c-.43.199-1.354.328-2.29.328-2.926 0-4.813-1.88-4.813-4.798 0-2.844 1.921-4.881 4.594-4.881 2.735 0 4.608 1.688 4.608 4.156 0 1.682-.554 2.769-1.416 2.769-.492 0-.772-.28-.772-.76V5.206H8.923v.834h-.11c-.266-.595-.881-.964-1.6-.964-1.4 0-2.378 1.162-2.378 2.823 0 1.737.957 2.906 2.379 2.906.8 0 1.415-.39 1.709-1.087h.11c.081.67.703 1.148 1.503 1.148 1.572 0 2.57-1.415 2.57-3.643zm-7.177.704c0-1.197.54-1.907 1.456-1.907.93 0 1.524.738 1.524 1.907S8.308 9.84 7.371 9.84c-.895 0-1.442-.725-1.442-1.914z" />
        </svg><input type="email" class="input-field" id="username" required placeholder="Email" autocomplete="off">
       </div>
       <div class="field">
        <svg viewbox="0 0 16 16" fill="currentColor" height="16" width="16" xmlns="http://www.w3.org/2000/svg" class="input-icon"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z" />
        </svg><input type="password" class="input-field" id="password" required placeholder="Senha">
       </div><small style="display: block; text-align: center; color: #64748b; margin-bottom: 1rem; font-size: 0.8125rem;"> Use seu email e senha cadastrados </small>
       <div class="login-buttons"><button type="submit" class="btn btn-primary" id="login-btn">
         <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 012 2v14a2 2 0 01-2 2h-4M10 17l5-5-5-5M21 12H9" />
         </svg><span id="login-button-text">Entrar</span> </button>
       </div>
       <div style="text-align: center;"><button type="button" class="btn-link" id="forgot-password-btn" onclick="showForgotPassword()"> Esqueceu a senha? </button>
       </div>
      </form>
     </div><div id="forgot-password-content" class="tab-content">
      <h2>Recuperar Senha</h2>
      <form id="forgot-password-form">
       <div class="field">
        <svg viewbox="0 0 16 16" fill="currentColor" height="16" width="16" xmlns="http://www.w3.org/2000/svg" class="input-icon"><path d="M13.106 7.222c0-2.967-2.249-5.032-5.482-5.032-3.35 0-5.646 2.318-5.646 5.702 0 3.493 2.235 5.708 5.762 5.708.862 0 1.689-.123 2.304-.335v-.862c-.43.199-1.354.328-2.29.328-2.926 0-4.813-1.88-4.813-4.798 0-2.844 1.921-4.881 4.594-4.881 2.735 0 4.608 1.688 4.608 4.156 0 1.682-.554 2.769-1.416 2.769-.492 0-.772-.28-.772-.76V5.206H8.923v.834h-.11c-.266-.595-.881-.964-1.6-.964-1.4 0-2.378 1.162-2.378 2.823 0 1.737.957 2.906 2.379 2.906.8 0 1.415-.39 1.709-1.087h.11c.081.67.703 1.148 1.503 1.148 1.572 0 2.57-1.415 2.57-3.643zm-7.177.704c0-1.197.54-1.907 1.456-1.907.93 0 1.524.738 1.524 1.907S8.308 9.84 7.371 9.84c-.895 0-1.442-.725-1.442-1.914z" />
        </svg><input type="email" class="input-field" id="recovery-email" required placeholder="Email de Cadastro" autocomplete="off">
       </div><small style="display: block; text-align: center; color: #64748b; margin-bottom: 1rem; font-size: 0.8125rem;"> Digite o email que você usou para se cadastrar </small>
       <div class="login-buttons"><button type="submit" class="btn btn-secondary" id="recovery-btn">
         <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
         </svg><span id="recovery-button-text">Enviar Link</span> </button>
       </div>
       <div style="text-align: center;"><button type="button" class="btn-link" onclick="backToLogin()"> Voltar ao Login </button>
       </div>
      </form>
     </div><div id="register-content" class="tab-content">
      <h2 id="register-title">Cadastro</h2>
      <form id="register-form">
       <div class="field">
        <svg viewbox="0 0 16 16" fill="currentColor" height="16" width="16" xmlns="http://www.w3.org/2000/svg" class="input-icon"><path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />
        </svg><input type="text" class="input-field" id="reg-name" required placeholder="Nome Completo" autocomplete="off">
       </div><div class="field">
        <svg viewbox="0 0 16 16" fill="currentColor" height="16" width="16" xmlns="http://www.w3.org/2000/svg" class="input-icon"><path d="M13.106 7.222c0-2.967-2.249-5.032-5.482-5.032-3.35 0-5.646 2.318-5.646 5.702 0 3.493 2.235 5.708 5.762 5.708.862 0 1.689-.123 2.304-.335v-.862c-.43.199-1.354.328-2.29.328-2.926 0-4.813-1.88-4.813-4.798 0-2.844 1.921-4.881 4.594-4.881 2.735 0 4.608 1.688 4.608 4.156 0 1.682-.554 2.769-1.416 2.769-.492 0-.772-.28-.772-.76V5.206H8.923v.834h-.11c-.266-.595-.881-.964-1.6-.964-1.4 0-2.378 1.162-2.378 2.823 0 1.737.957 2.906 2.379 2.906.8 0 1.415-.39 1.709-1.087h.11c.081.67.703 1.148 1.503 1.148 1.572 0 2.57-1.415 2.57-3.643zm-7.177.704c0-1.197.54-1.907 1.456-1.907.93 0 1.524.738 1.524 1.907S8.308 9.84 7.371 9.84c-.895 0-1.442-.725-1.442-1.914z" />
        </svg><input type="email" class="input-field" id="reg-email" required placeholder="Email (para login)" autocomplete="off">
       </div>
       <div class="field">
        <svg viewbox="0 0 16 16" fill="currentColor" height="16" width="16" xmlns="http://www.w3.org/2000/svg" class="input-icon"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z" />
        </svg><input type="text" class="input-field" id="reg-nickname" placeholder="Apelido (opcional)" autocomplete="off">
       </div>
       <div class="field">
        <svg viewbox="0 0 16 16" fill="currentColor" height="16" width="16" xmlns="http://www.w3.org/2000/svg" class="input-icon"><path d="M12.166 8.94c-.524 1.062-1.234 2.12-1.96 3.07A31.493 31.493 0 0 1 8 14.58a31.481 31.481 0 0 1-2.206-2.57c-.726-.95-1.436-2.008-1.96-3.07C3.304 7.867 3 6.862 3 6a5 5 0 0 1 10 0c0 .862-.305 1.867-.834 2.94zM8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10z" /> <path d="M8 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 1a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />
        </svg><input type="text" class="input-field" id="reg-location" required placeholder="Local de Lotação" autocomplete="off">
       </div>
       <div class="field">
        <svg viewbox="0 0 16 16" fill="currentColor" height="16" width="16" xmlns="http://www.w3.org/2000/svg" class="input-icon"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z" />
        </svg><input type="password" class="input-field" id="reg-password" required placeholder="Senha (mín. 6 dígitos)">
       </div>
       <div class="field">
        <svg viewbox="0 0 16 16" fill="currentColor" height="16" width="16" xmlns="http://www.w3.org/2000/svg" class="input-icon"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z" />
        </svg><input type="password" class="input-field" id="reg-password-confirm" required placeholder="Confirmar Senha">
       </div><small style="display: block; text-align: center; color: #64748b; margin-bottom: 1rem; font-size: 0.8125rem;"> A senha deve ter no mínimo 6 dígitos </small>
       <div class="login-buttons"><button type="submit" class="btn btn-secondary" id="register-btn">
         <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2M12.5 7a4 4 0 11-8 0 4 4 0 018 0z" />
         </svg><span id="register-button-text">Cadastrar</span> </button>
       </div>
      </form>
     </div>
    </div>
   </div>
  </div><div id="manager-screen" class="container hidden">
   <div class="header">
    <h1 id="manager-title">
     <svg class="logo-icon" xmlns="http://www.w3.org/2000/svg" height="40" width="40" viewbox="0 0 640 640" fill="white"><path d="M541.9 139.5C546.4 127.7 543.6 114.3 534.7 105.4C525.8 96.5 512.4 93.6 500.6 98.2L84.6 258.2C71.9 263 63.7 275.2 64 288.7C64.3 302.2 73.1 314.1 85.9 318.3L262.7 377.2L321.6 554C325.9 566.8 337.7 575.6 351.2 575.9C364.7 576.2 376.9 568 381.8 555.4L541.8 139.4z" />
     </svg> Dashboard Gerencial</h1>
    <p id="manager-department">COORDENAÇÃO DE SUPORTE E LOGÍSTICA - SEMCAS</p>
   </div>
   <div class="card">
    <div class="user-info">
     <div class="manager-profile">
      <div class="profile-photo-container">
       <div class="profile-photo" id="manager-photo"></div>
       <div class="photo-upload-btn" id="upload-photo-btn">
        <svg width="12" height="12" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z" /> <circle cx="12" cy="13" r="4" />
        </svg>
       </div><input type="file" id="photo-input" accept="image/*" style="display: none;">
      </div>
      <div class="user-details"><span id="manager-user-name"><strong>Welligton Luis</strong></span> <span class="location" id="manager-user-location">Gestor - Administração</span>
      </div>
     </div><button class="btn btn-logout" id="manager-logout-btn">
      <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9" />
      </svg> Sair </button>
    </div><div class="dashboard-grid">
     <div class="dashboard-card">
      <div class="dashboard-icon">
       <svg width="32" height="32" viewbox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
       </svg>
      </div>
      <div class="dashboard-content">
       <h3 id="total-reports">0</h3>
       <p>Total de Reports</p>
      </div>
     </div>
     <div class="dashboard-card">
      <div class="dashboard-icon">
       <svg width="32" height="32" viewbox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><path d="M20 6L9 17l-5-5" />
       </svg>
      </div>
      <div class="dashboard-content">
       <h3 id="sent-reports">0</h3>
       <p>Reports Enviados</p>
      </div>
     </div>
     <div class="dashboard-card">
      <div class="dashboard-icon">
       <svg width="32" height="32" viewbox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><circle cx="12" cy="12" r="10" /> <path d="M12 6v6l4 2" />
       </svg>
      </div>
      <div class="dashboard-content">
       <h3 id="pending-reports">0</h3>
       <p>Reports Pendentes</p>
      </div>
     </div>
     <div class="dashboard-card">
      <div class="dashboard-icon">
       <svg width="32" height="32" viewbox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />
       </svg>
      </div>
      <div class="dashboard-content">
       <h3 id="total-km">0</h3>
       <p>Total KM Rodados</p>
      </div>
     </div>
     <div class="dashboard-card">
      <div class="dashboard-icon">
       <svg width="32" height="32" viewbox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
       </svg>
      </div>
      <div class="dashboard-content">
       <h3 id="active-drivers">0</h3>
       <p>Condutores Ativos</p>
      </div>
     </div>
     <div class="dashboard-card">
      <div class="dashboard-icon">
       <svg width="32" height="32" viewbox="0 0 24 24" fill="none" stroke="#06b6d4" stroke-width="2"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z" /> <polyline points="3.27,6.96 12,12.01 20.73,6.96" /> <line x1="12" y1="22.08" x2="12" y2="12" />
       </svg>
      </div>
      <div class="dashboard-content">
       <h3 id="avg-km-per-report">0</h3>
       <p>Média KM/Report</p>
      </div>
     </div>
     <div class="dashboard-card">
      <div class="dashboard-icon">
       <svg width="32" height="32" viewbox="0 0 24 24" fill="none" stroke="#84cc16" stroke-width="2"><polyline points="22,12 18,12 15,21 9,3 6,12 2,12" />
       </svg>
      </div>
      <div class="dashboard-content">
       <h3 id="efficiency-rate">0%</h3>
       <p>Taxa de Eficiência</p>
      </div>
     </div>
     <div class="dashboard-card">
      <div class="dashboard-icon">
       <svg width="32" height="32" viewbox="0 0 24 24" fill="none" stroke="#f97316" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /> <line x1="16" y1="2" x2="16" y2="6" /> <line x1="8" y1="2" x2="8" y2="6" /> <line x1="3" y1="10" x2="21" y2="10" />
       </svg>
      </div>
      <div class="dashboard-content">
       <h3 id="reports-today">0</h3>
       <p>Reports Hoje</p>
      </div>
     </div>
    </div><div class="bi-analytics-section"><div class="card">
      <div class="analytics-header">
       <h2>
        <svg width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="#253d70" stroke-width="2" style="vertical-align: middle; margin-right: 8px;"><line x1="18" y1="20" x2="18" y2="10" /> <line x1="12" y1="20" x2="12" y2="4" /> <line x1="6" y1="20" x2="6" y2="14" />
        </svg> Analytics &amp; Business Intelligence</h2>
       <div class="analytics-controls"><select id="analytics-period" class="filter-select"> <option value="7">Últimos 7 dias</option> <option value="30" selected>Últimos 30 dias</option> <option value="90">Últimos 90 dias</option> <option value="365">Último ano</option> <option value="all">Todo o período</option> </select> <button class="btn btn-primary" id="refresh-analytics-btn">
         <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23,4 23,10 17,10" /> <polyline points="1,20 1,14 7,14" /> <path d="M20.49,9A9,9,0,0,0,5.64,5.64L1,10m22,4L18.36,18.36A9,9,0,0,1,3.51,15" />
         </svg> Atualizar </button>
       </div>
      </div>
     </div><div class="charts-grid"><div class="card chart-card">
       <div class="chart-header">
        <h3>
         <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" style="vertical-align: middle; margin-right: 6px;"><polyline points="23,6 13.5,15.5 8.5,10.5 1,18" /> <polyline points="17,6 23,6 23,12" />
         </svg> Tendência de Reports</h3>
        <div class="chart-legend"><span class="legend-item"> <span class="legend-color" style="background: #10b981;"></span> Enviados </span> <span class="legend-item"> <span class="legend-color" style="background: #f59e0b;"></span> Pendentes </span>
        </div>
       </div>
       <div class="chart-container">
        <canvas id="reports-trend-chart"></canvas>
       </div>
      </div><div class="card chart-card">
       <div class="chart-header">
        <h3>
         <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" style="vertical-align: middle; margin-right: 6px;"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z" /> <polyline points="3.27,6.96 12,12.01 20.73,6.96" /> <line x1="12" y1="22.08" x2="12" y2="12" />
         </svg> Distribuição de KM por Condutor</h3>
        <div class="chart-info"><span id="km-chart-total">Total: 0 km</span>
        </div>
       </div>
       <div class="chart-container">
        <canvas id="km-distribution-chart"></canvas>
       </div>
      </div><div class="card chart-card">
       <div class="chart-header">
        <h3>
         <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2" style="vertical-align: middle; margin-right: 6px;"><path d="M21.21 15.89A10 10 0 118 2.83" /> <path d="M22 12A10 10 0 0012 2v10z" />
         </svg> Status dos Reports</h3>
        <div class="chart-legend"><span class="legend-item"> <span class="legend-color" style="background: #10b981;"></span> Enviados </span> <span class="legend-item"> <span class="legend-color" style="background: #f59e0b;"></span> Pendentes </span>
        </div>
       </div>
       <div class="chart-container">
        <canvas id="status-pie-chart"></canvas>
       </div>
      </div><div class="card chart-card full-width">
       <div class="chart-header">
        <h3>
         <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" style="vertical-align: middle; margin-right: 6px;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /> <line x1="16" y1="2" x2="16" y2="6" /> <line x1="8" y1="2" x2="8" y2="6" /> <line x1="3" y1="10" x2="21" y2="10" /> <path d="M8 14h.01M12 14h.01M16 14h.01M8 18h.01M12 18h.01M16 18h.01" />
         </svg> Mapa de Calor - Atividade Diária</h3>
        <div class="heatmap-legend"><span>Menos ativo</span>
         <div class="heatmap-scale">
          <div class="heatmap-cell level-0"></div>
          <div class="heatmap-cell level-1"></div>
          <div class="heatmap-cell level-2"></div>
          <div class="heatmap-cell level-3"></div>
          <div class="heatmap-cell level-4"></div>
         </div><span>Mais ativo</span>
        </div>
       </div>
       <div class="heatmap-container" id="activity-heatmap"></div>
      </div><div class="card chart-card">
       <div class="chart-header">
        <h3>
         <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" style="vertical-align: middle; margin-right: 6px;"><polyline points="22,12 18,12 15,21 9,3 6,12 2,12" />
         </svg> Métricas de Performance</h3>
       </div>
       <div class="performance-metrics">
        <div class="metric-item">
         <div class="metric-icon">
          <svg width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 010-5H6" /> <path d="M18 9h1.5a2.5 2.5 0 000-5H18" /> <path d="M4 22h16" /> <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" /> <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" /> <path d="M18 2H6v7a6 6 0 0012 0V2z" />
          </svg>
         </div>
         <div class="metric-content">
          <div class="metric-value" id="top-performer">
           -
          </div>
          <div class="metric-label">
           Top Performer
          </div>
         </div>
        </div>
        <div class="metric-item">
         <div class="metric-icon">
          <svg width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10" /> <line x1="12" y1="20" x2="12" y2="4" /> <line x1="6" y1="20" x2="6" y2="14" />
          </svg>
         </div>
         <div class="metric-content">
          <div class="metric-value" id="avg-reports-per-driver">
           0
          </div>
          <div class="metric-label">
           Média Reports/Condutor
          </div>
         </div>
        </div>
        <div class="metric-item">
         <div class="metric-icon">
          <svg width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><circle cx="12" cy="12" r="10" /> <path d="M16 12l-4-4-4 4" /> <path d="M12 16V8" />
          </svg>
         </div>
         <div class="metric-content">
          <div class="metric-value" id="completion-rate">
           0%
          </div>
          <div class="metric-label">
           Taxa de Conclusão
          </div>
         </div>
        </div>
        <div class="metric-item">
         <div class="metric-icon">
          <svg width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2"><polyline points="23,6 13.5,15.5 8.5,10.5 1,18" /> <polyline points="17,6 23,6 23,12" />
          </svg>
         </div>
         <div class="metric-content">
          <div class="metric-value" id="growth-rate">
           0%
          </div>
          <div class="metric-label">
           Crescimento Mensal
          </div>
         </div>
        </div>
       </div>
      </div><div class="card chart-card">
       <div class="chart-header">
        <h3>
         <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="#06b6d4" stroke-width="2" style="vertical-align: middle; margin-right: 6px;"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z" /> <circle cx="12" cy="10" r="3" />
         </svg> Análise por Lotação</h3>
       </div>
       <div class="location-analysis" id="location-analysis"></div>
      </div>
     </div><div class="card">
      <div class="table-header">
       <h2>
        <svg width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="#253d70" stroke-width="2" style="vertical-align: middle; margin-right: 8px;"><circle cx="11" cy="11" r="8" /> <path d="M21 21l-4.35-4.35" /> <circle cx="11" cy="8" r="2" /> <path d="M11 10v6" />
        </svg> Análise Avançada</h2>
       <div class="advanced-controls"><button class="btn btn-secondary" id="predictive-analysis-btn">
         <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z" />
         </svg> Análise Preditiva </button> <button class="btn btn-primary" id="anomaly-detection-btn">
         <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" /> <path d="M12 8v4M12 16h.01" />
         </svg> Detectar Anomalias </button>
       </div>
      </div><div class="insights-panel" id="insights-panel">
       <div class="insight-card">
        <div class="insight-icon">
         <svg width="32" height="32" viewbox="0 0 24 24" fill="none" stroke="#0ea5e9" stroke-width="2"><circle cx="12" cy="12" r="5" /> <line x1="12" y1="1" x2="12" y2="3" /> <line x1="12" y1="21" x2="12"y2="23" /> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" /> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" /> <line x1="1" y1="12" x2="3" y2="12" /> <line x1="21" y1="12" x2="23" y2="12" /> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" /> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
         </svg>
        </div>
        <div class="insight-content">
         <h4>Insights Automáticos</h4>
         <p>Análises serão exibidas aqui baseadas nos dados disponíveis.</p>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div><div class="card">
    <div class="table-header">
     <h2>Ranking de Condutores</h2>
     <div class="ranking-filters"><select id="ranking-filter" class="filter-select"> <option value="km">Por KM Rodados</option> <option value="reports">Por Número de Reports</option> <option value="efficiency">Por Eficiência</option> </select> <button class="btn btn-secondary" id="export-ranking-btn">
       <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3" />
       </svg> Exportar Ranking </button>
     </div>
    </div>
    <div class="ranking-container">
     <div class="ranking-item ranking-header">
      <div class="ranking-position">
       #
      </div>
      <div class="ranking-driver">
       Condutor
      </div>
      <div class="ranking-location">
       Lotação
      </div>
      <div class="ranking-metric">
       KM Total
      </div>
      <div class="ranking-reports">
       Reports
      </div>
      <div class="ranking-avg">
       Média KM/Report
      </div>
     </div>
     <div id="ranking-list"></div>
    </div>
   </div><div class="card">
    <div class="table-header">
     <h2>Relatórios Detalhados</h2>
     <div class="reports-controls">
      <div class="search-filters"><input type="text" id="search-driver" class="filter-select" placeholder="Buscar por condutor..."> <input type="text" id="search-plate" class="filter-select" placeholder="Buscar por placa..."> <input type="date" id="date-from" class="filter-select"> <input type="date" id="date-to" class="filter-select">
      </div>
      <div class="export-buttons"><button class="btn btn-primary" id="export-pdf-btn">
        <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" /> <polyline points="14,2 14,8 20,8" /> <line x1="16" y1="13" x2="8" y2="13" /> <line x1="16" y1="17" x2="8" y2="17" /> <polyline points="10,9 9,9 8,9" />
        </svg> Exportar PDF </button> <button class="btn btn-secondary" id="export-excel-btn">
        <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" /> <polyline points="14,2 14,8 20,8" /> <rect x="8" y="12" width="8" height="6" />
        </svg> Exportar Excel </button> <button class="btn btn-gps" id="backup-data-btn" style="background: #0ea5e9; color: white;">
        <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" /> <polyline points="7,10 12,15 17,10" /> <line x1="12" y1="15" x2="12" y2="3" />
        </svg> Backup Dados </button> <button class="btn" id="storage-stats-btn" style="background: #8b5cf6; color: white;">
        <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2" />
        </svg> Estatísticas </button>
      </div>
     </div>
    </div>
   </div><div class="card">
    <div class="table-header">
     <h2>Todos os Reports</h2>
     <div class="table-filters"><select id="status-filter" class="filter-select"> <option value="all">Todos os Status</option> <option value="Enviado">Apenas Enviados</option> <option value="Pendente">Apenas Pendentes</option> </select> <select id="driver-filter" class="filter-select"> <option value="all">Todos os Condutores</option> </select>
     </div>
    </div>
    <div class="table-container">
     <table>
      <thead>
       <tr>
        <th>Condutor</th>
        <th>Placa</th>
        <th>Data</th>
        <th>Destino</th>
        <th>KM Inicial</th>
        <th>KM Final</th>
        <th>Distância</th>
        <th>Status</th>
        <th>Lotação</th>
        <th>Responsável</th>
        <th>Unidade</th>
       </tr>
      </thead>
      <tbody id="manager-records-tbody">
       <tr>
        <td colspan="11" class="empty-state">
         <svg viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
         </svg><p>Nenhum registro encontrado</p></td>
       </tr>
      </tbody>
     </table>
    </div>
   </div>
  </div><div id="main-screen" class="container hidden">
   <div class="header-with-weather">
    <div class="header-content">
     <h1 id="main-title" style="font-size: 2rem; font-weight: 700; margin: 0 0 0.5rem 0; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1rem;">
      <svg class="logo-icon" xmlns="http://www.w3.org/2000/svg" height="40" width="40" viewbox="0 0 640 640" fill="white"><path d="M541.9 139.5C546.4 127.7 543.6 114.3 534.7 105.4C525.8 96.5 512.4 93.6 500.6 98.2L84.6 258.2C71.9 263 63.7 275.2 64 288.7C64.3 302.2 73.1 314.1 85.9 318.3L262.7 377.2L321.6 554C325.9 566.8 337.7 575.6 351.2 575.9C364.7 576.2 376.9 568 381.8 555.4L541.8 139.4z" />
      </svg> Controle de Tráfego Diário</h1>
     <p id="main-department" style="font-size: 1rem; opacity: 0.9; margin: 0;">COORDENAÇÃO DE SUPORTE E LOGÍSTICA - SEMCAS</p>
    </div><div class="weather-card">
     <div class="info-section">
      <div class="background-design">
       <div class="circle"></div>
       <div class="circle"></div>
       <div class="circle"></div>
      </div>
      <div class="left-side">
       <div class="location-name" id="weather-location">
        São Luís, MA
       </div>
       <div class="weather-info">
        <div>
         <svg width="45" height="45" viewbox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="5" /> <line x1="12" y1="1" x2="12" y2="3" /> <line x1="12" y1="21" x2="12" y2="23" /> <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" /> <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" /> <line x1="1" y1="12" x2="3" y2="12" /> <line x1="21" y1="12" x2="23" y2="12" /> <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" /> <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
         </svg>
        </div>
        <div><span class="temperature" id="current-temp">28</span> <span style="font-size: 14pt;">°C</span>
        </div>
       </div>
      </div>
      <div class="right-side">
       <div>
        <div class="hour" id="current-hour">
         --:--
        </div>
        <div class="date" id="current-date">
         -- --- ----
        </div>
       </div>
      </div>
     </div>
     <div class="days-section"><button> <span class="day">SEG</span>
       <div class="icon-weather-day">
        <svg width="14" height="14" viewbox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="4" />
        </svg>
       </div></button> <button> <span class="day">TER</span>
       <div class="icon-weather-day">
        <svg width="14" height="14" viewbox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="4" />
        </svg>
       </div></button> <button> <span class="day">QUA</span>
       <div class="icon-weather-day">
        <svg width="14" height="14" viewbox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="4" />
        </svg>
       </div></button> <button> <span class="day">QUI</span>
       <div class="icon-weather-day">
        <svg width="14" height="14" viewbox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="4" />
        </svg>
       </div></button> <button> <span class="day">SEX</span>
       <div class="icon-weather-day">
        <svg width="14" height="14" viewbox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="4" />
        </svg>
       </div></button>
     </div>
    </div>
   </div>
   <div class="card">
    <div class="user-info">
     <div class="user-details"><span>Condutor: <strong id="logged-user"></strong></span> <span class="location" id="user-location"></span>
     </div><button class="btn btn-logout" id="logout-btn">
      <svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9" />
      </svg> Sair </button>
    </div><div id="sync-status" class="sync-status">
     <div class="gps-info">
      <div class="gps-indicator"></div>
      <div>
       <div class="gps-text">
        Sincronizando dados...
       </div>
       <div class="gps-details">
        Enviando registros offline para o servidor
       </div>
      </div>
     </div>
    </div><div id="manual-form-container">
     <form id="traffic-form">
      <div class="form-grid">
       <div class="form-group"><label for="condutor">Condutor</label> <input type="text" id="condutor" required disabled>
       </div>
       <div class="form-group"><label for="placa">Placa do Veículo</label> <input type="text" id="placa" required placeholder="ABC-1234">
       </div>
       <div class="form-group"><label for="data">Data</label> <input type="date" id="data" required>
       </div>
       <div class="form-group"><label for="destino">Destino</label> <input type="text" id="destino" required placeholder="Ex: Partida para a Beira Mar">
       </div>
       <div class="form-group"><label for="km-inicial">KM Inicial</label> <input type="number" id="km-inicial" required min="0" step="0.1"> <small>O KM Final será preenchido automaticamente pelo próximo registro</small>
       </div>
      </div>
      <div class="button-group"><button type="button" class="btn btn-primary" id="btn-send-direct">
        <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />
        </svg><span id="text-send-direct">Enviar Direto</span> </button> <button type="button" class="btn btn-secondary" id="btn-add-queue">
        <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14" />
        </svg><span id="text-add-queue">Adicionar ao Resumo</span> </button>
      </div>
     </form>
    </div>
   </div>
   <div class="card">
    <div class="table-header">
     <h2 id="table-title">Resumo de Reports</h2>
     <div class="table-actions"><button class="btn btn-primary" id="btn-send-selected" disabled>
       <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />
       </svg><span id="text-send-selected">Enviar Selecionados</span> </button> <button class="btn btn-danger" id="btn-clear-all">
       <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" />
       </svg><span id="text-clear-all">Limpar Todos</span> </button>
     </div>
    </div>
    <div class="table-container">
     <table>
      <thead>
       <tr>
        <th class="checkbox-cell"><input type="checkbox" id="select-all"></th>
        <th>Condutor</th>
        <th>Placa</th>
        <th>Data</th>
        <th>Destino</th>
        <th>KM Inicial</th>
        <th>KM Final</th>
        <th>Distância</th>
        <th>Status</th>
        <th>Responsável</th>
       </tr>
      </thead>
      <tbody id="records-tbody">
       <tr>
        <td colspan="10" class="empty-state">
         <svg viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
         </svg><p>Nenhum registro na fila</p></td>
       </tr>
      </tbody>
     </table>
    </div>
   </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

  <script>
    // SUA CONFIGURAÇÃO DO FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyCAnfRhjlnlk0z_IXbK5tQviynh5ZzgRmM",
      authDomain: "controle-de-trafego-2fbe3.firebaseapp.com",
      projectId: "controle-de-trafego-2fbe3",
      storageBucket: "controle-de-trafego-2fbe3.firebasestorage.app",
      messagingSenderId: "665507103572",
      appId: "1:665507103572:web:6910dc97830e64b2fcfec1",
      measurementId: "G-SFGRXTEP8E"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);

    // Referências dos serviços do Firebase
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    // ----- CÓDIGO DO APLICATIVO -----
    
    const defaultConfig = {
      page_title: "Sistema de Controle de Tráfego",
      department_name: "COORDENAÇÃO DE SUPORTE E LOGÍSTICA - SEMCAS",
      // ... (resto do seu objeto defaultConfig)
    };

    let allRecords = [];
    let isProcessing = false;
    let currentUser = null; // Objeto de usuário global
    // O objeto 'registeredUsers' e 'DataStorage' foram removidos e substituídos pelo Firebase

    async function onConfigChange(config) {
      // ... (esta função permanece a mesma)
    }

    function adjustColor(color, percent) {
      // ... (esta função permanece a mesma)
    }

    function switchTab(tab) {
      // ... (esta função permanece a mesma)
    }

    function updateWeatherCard() {
      // ... (esta função permanece a mesma)
    }

    async function initializeApp() {
      console.log('🚀 Inicializando Sistema de Controle de Tráfego...');
      
      // O 'DataStorage' foi removido.
      // O carregamento de dados agora é feito pelo listener de autenticação
      
      setupEventListeners();
      updateWeatherCard();
      setInterval(updateWeatherCard, 60000);

      // NOVO: Listener de Estado de Autenticação
      // Este é o novo ponto de entrada principal do aplicativo
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          // Usuário está logado
          console.log('✅ Usuário logado:', user.uid);
          await loadUserDataAndRecords(user);
          
        } else {
          // Usuário está deslogado
          console.log('🔒 Usuário deslogado.');
          currentUser = null;
          allRecords = [];
          document.getElementById('main-screen').classList.add('hidden');
          document.getElementById('manager-screen').classList.add('hidden');
          document.getElementById('login-screen').classList.remove('hidden');
          switchTab('login');
        }
      });
    }
    
    // NOVA FUNÇÃO: Carrega os dados do usuário e os registros após o login
    async function loadUserDataAndRecords(firebaseUser) {
      try {
        // 1. Buscar perfil do usuário no Firestore
        const userDoc = await db.collection("users").doc(firebaseUser.uid).get();
        if (!userDoc.exists) {
          showToast('Perfil de usuário não encontrado', 'error');
          await auth.signOut();
          return;
        }

        const userData = userDoc.data();
        const displayName = userData.nickname || userData.name.split(' ')[0];
        
        currentUser = {
          uid: firebaseUser.uid,
          email: firebaseUser.email,
          name: userData.name,
          displayName: displayName,
          location: userData.location,
          type: userData.type || 'condutor',
          photoURL: userData.photoURL || null
        };
        
        // 2. Definir a consulta de registros
        let recordsQuery = db.collection("records").orderBy("created_at", "desc");
        
        // Otimização: Gestores carregam tudo, condutores carregam apenas os seus
        if (currentUser.type !== 'gestor') {
          recordsQuery = recordsQuery.where("user_uid", "==", currentUser.uid);
        }
        
        const recordsSnapshot = await recordsQuery.limit(500).get(); // Limitar carga inicial
                                    
        allRecords = recordsSnapshot.docs.map(doc => {
          const data = doc.data();
          
          // **CORREÇÃO IMPORTANTE:** Converter Timestamps de volta para strings
          if (data.data && data.data.toDate) {
            data.data = data.data.toDate().toISOString().split('T')[0];
          }
          if (data.created_at && data.created_at.toDate) {
            data.created_at = data.created_at.toDate().toISOString();
          }
          
          return {
            id: doc.id, // ID do documento do Firestore
            ...data
          };
        });
        
        console.log(`📂 Dados carregados do Firestore: ${allRecords.length} registros`);

        // 3. Configurar a UI com base no tipo de usuário
        document.getElementById('login-screen').classList.add('hidden');
        
        if (currentUser.type === 'gestor') {
          document.getElementById('manager-screen').classList.remove('hidden');
          document.getElementById('manager-user-name').innerHTML = `<strong>${currentUser.name}</strong>`;
          document.getElementById('manager-user-location').textContent = `Gestor - ${currentUser.location}`;
          
          // Carregar foto do gestor
          if (currentUser.photoURL) {
            document.getElementById('manager-photo').innerHTML = `<img src="${currentUser.photoURL}" alt="Foto do Gestor" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
          } else {
             document.getElementById('manager-photo').innerHTML = ''; // Limpar se não houver foto
          }
          
          updateManagerDashboard(); // Função completa do gestor
          
        } else {
          document.getElementById('main-screen').classList.remove('hidden');
          document.getElementById('logged-user').textContent = currentUser.displayName;
          document.getElementById('user-location').textContent = `Lotação: ${currentUser.location}`;
          document.getElementById('condutor').value = currentUser.displayName;
          
          const today = new Date().toISOString().split('T')[0];
          document.getElementById('data').value = today;
          
          renderTable(); // Renderiza apenas os registros do condutor
          updateSelectAllCheckbox();
        }
        
        showToast(`Bem-vindo, ${currentUser.displayName}!`, 'success');

      } catch (error) {
        console.error("Erro ao carregar dados do usuário:", error);
        showToast("Erro ao carregar dados", "error");
        await auth.signOut();
      }
    }

    function setupEventListeners() {
      // (a maioria dos event listeners permanece a mesma)
      document.getElementById('login-form').addEventListener('submit', handleLogin);
      document.getElementById('register-form').addEventListener('submit', handleRegister);
      document.getElementById('forgot-password-form').addEventListener('submit', handleForgotPassword);
      document.getElementById('logout-btn').addEventListener('click', handleLogout);
      document.getElementById('manager-logout-btn').addEventListener('click', handleLogout);

      // ... (outros listeners) ...
      document.getElementById('btn-send-direct').addEventListener('click', handleSendDirect);
      document.getElementById('btn-add-queue').addEventListener('click', handleAddToQueue);
      document.getElementById('btn-send-selected').addEventListener('click', handleSendSelected);
      document.getElementById('btn-clear-all').addEventListener('click', handleClearAll);
      document.getElementById('select-all').addEventListener('change', handleSelectAll);

      document.getElementById('confirm-responsible-btn').addEventListener('click', confirmResponsible);
      document.getElementById('cancel-responsible-btn').addEventListener('click', hideResponsibleModal);

      document.getElementById('ranking-filter').addEventListener('change', updateRanking);
      document.getElementById('status-filter').addEventListener('change', filterManagerTable);
      document.getElementById('driver-filter').addEventListener('change', filterManagerTable);

      document.getElementById('upload-photo-btn').addEventListener('click', () => {
        document.getElementById('photo-input').click();
      });
      document.getElementById('photo-input').addEventListener('change', handlePhotoUpload);
      
      // ... (etc)
    }

    // --- FUNÇÕES DE AUTENTICAÇÃO ATUALIZADAS ---

    async function handleLogin(e) {
      e.preventDefault();
      
      const email = document.getElementById('username').value.trim(); // Agora é email
      const password = document.getElementById('password').value;

      if (!email || !password) {
        showToast('Preencha e-mail e senha', 'error');
        return;
      }

      const btn = document.getElementById('login-btn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div> Entrando...';

      try {
        await auth.signInWithEmailAndPassword(email, password);
        // Sucesso! O listener 'onAuthStateChanged' cuidará do resto.
      } catch (error) {
        console.error("Erro no login:", error);
        let msg = 'E-mail ou senha incorretos';
        if (error.code === 'auth/user-not-found') {
          msg = 'Usuário não encontrado';
        } else if (error.code === 'auth/wrong-password') {
          msg = 'Senha incorreta';
        }
        showToast(msg, 'error');
        btn.disabled = false;
        btn.innerHTML = '<svg width="20" height="20" ...></svg><span id="login-button-text">Entrar</span>';
      }
    }

    async function handleRegister(e) {
      e.preventDefault();
      
      const name = document.getElementById('reg-name').value.trim();
      const email = document.getElementById('reg-email').value.trim(); // Novo campo
      const nickname = document.getElementById('reg-nickname').value.trim();
      const location = document.getElementById('reg-location').value.trim();
      const password = document.getElementById('reg-password').value;
      const confirmPassword = document.getElementById('reg-password-confirm').value;

      if (!name || !email || !location || !password || !confirmPassword) {
        showToast('Preencha todos os campos obrigatórios', 'error');
        return;
      }
      
      if (password.length < 6) {
          showToast('A senha deve ter no mínimo 6 caracteres', 'error');
          return;
      }

      if (password !== confirmPassword) {
        showToast('As senhas não coincidem', 'error');
        return;
      }

      const btn = document.getElementById('register-btn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div> Cadastrando...';

      try {
        // 1. Criar o usuário no Firebase Auth
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;

        // 2. Determinar o tipo de usuário (exemplo simples)
        const userType = (name.toLowerCase() === 'welligton luis') ? 'gestor' : 'condutor';

        // 3. Salvar os dados adicionais do usuário no Firestore
        await db.collection("users").doc(user.uid).set({
          name: name,
          email: email,
          nickname: nickname || name.split(' ')[0],
          location: location,
          type: userType,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast('Cadastro realizado com sucesso! Faça login.', 'success');
        document.getElementById('register-form').reset();
        switchTab('login');

      } catch (error) {
        console.error("Erro no cadastro:", error);
        let msg = 'Erro ao cadastrar';
        if (error.code === 'auth/email-already-in-use') {
          msg = 'Este e-mail já está em uso';
        }
        showToast(msg, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg width="20" height="20" ...></svg><span id="register-button-text">Cadastrar</span>';
      }
    }

    async function handleForgotPassword(e) {
      e.preventDefault();
      
      const email = document.getElementById('recovery-email').value.trim();
      if (!email) {
        showToast('Digite seu e-mail de cadastro', 'error');
        return;
      }
      
      const btn = document.getElementById('recovery-btn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div> Enviando...';

      try {
        await auth.sendPasswordResetEmail(email);
        showToast('Link de recuperação enviado para seu e-mail!', 'success');
        backToLogin();
      } catch (error) {
        console.error("Erro ao recuperar senha:", error);
        showToast('Erro ao enviar e-mail. Verifique o e-mail digitado.', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg width="20" height="20" ...></svg><span id="recovery-button-text">Recuperar Senha</span>';
      }
    }

    async function handleLogout() {
      try {
        await auth.signOut();
        // O listener 'onAuthStateChanged' cuidará de limpar a UI
        showToast('Logout realizado com sucesso', 'success');
      } catch (error) {
        console.error("Erro ao sair:", error);
        showToast('Erro ao tentar sair', 'error');
      }
    }

    // --- FUNÇÕES DE DADOS ATUALIZADAS (FIRESTORE) ---

    // Nova função auxiliar para adicionar registros
    async function addRecordToFirestore(recordData) {
      try {
        // Adiciona dados de auditoria
        recordData.user_uid = currentUser.uid;
        recordData.created_at = firebase.firestore.FieldValue.serverTimestamp(); 
        
        // Converte data para timestamp para ordenação correta no firestore
        recordData.data = firebase.firestore.Timestamp.fromDate(new Date(recordData.data));

        const docRef = await db.collection("records").add(recordData);
        
        // Adiciona o ID do Firestore e dados de timestamp ao objeto local
        const newRecord = { 
          ...recordData, 
          id: docRef.id, 
          created_at: new Date().toISOString(), // Simulação para UI imediata
          data: recordData.data.toDate().toISOString().split('T')[0] // Converte de volta
        }; 
        
        allRecords.unshift(newRecord); // Adiciona no início do array local
        return newRecord;
        
      } catch (error) {
        console.error("Erro ao salvar registro no Firestore: ", error);
        showToast("Erro ao salvar no servidor", "error");
        return null;
      }
    }


    function getFormData() {
      const condutor = document.getElementById('condutor').value.trim();
      const placa = document.getElementById('placa').value.trim().toUpperCase();
      const data = document.getElementById('data').value; // Mantenha como string por enquanto
      const destino = document.getElementById('destino').value.trim();
      const kmInicial = parseFloat(document.getElementById('km-inicial').value);

      if (!condutor || !placa || !data || !destino || isNaN(kmInicial)) {
        return null;
      }

      // Buscar o último registro PENDENTE do mesmo condutor e placa para atualizar o KM Final
      const lastRecord = allRecords
        .filter(r => r.condutor === condutor && r.placa === placa && r.km_final === null && r.status === 'Pendente')
        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];

      // Se existe um registro anterior sem KM Final, atualiza com o KM Inicial atual
      if (lastRecord) {
        lastRecord.km_final = kmInicial;
        
        // Atualizar este registro no Firestore também!
        db.collection("records").doc(lastRecord.id).update({
          km_final: kmInicial
        }).catch(err => console.error("Erro ao atualizar km_final:", err));
      }

      return {
        // 'id' será gerado pelo Firestore
        condutor,
        placa,
        data, // Será convertido para Timestamp no 'addRecordToFirestore'
        destino,
        km_inicial: kmInicial,
        km_final: null, // KM Final será preenchido pelo próximo registro
        status: 'Pendente',
        // created_at e user_uid serão adicionados no 'addRecordToFirestore'
        user_id: currentUser.name, // Mantendo para consistência do seu dashboard
        user_location: currentUser.location,
        module_type: 'manual'
      };
    }

    function clearForm() {
      // ... (esta função permanece a mesma)
    }

    async function handleSendDirect() {
      if (isProcessing) return;

      let formData = getFormData(); // 'let' em vez de 'const'
      if (!formData) {
        showToast('Preencha todos os campos corretamente', 'error');
        return;
      }

      isProcessing = true;
      const btn = document.getElementById('btn-send-direct');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<div class="spinner"></div> Enviando...';
      btn.disabled = true;

      formData.status = 'Enviado'; // Enviar direto
      
      const newRecord = await addRecordToFirestore(formData);
      
      if (newRecord) {
        renderTable();
        updateSelectAllCheckbox();
        if (currentUser && currentUser.type === 'gestor') {
          updateManagerDashboard();
        }
        showToast('Registro enviado com sucesso!', 'success');
        clearForm();
      } else {
        // Falha ao salvar
        showToast('Erro ao enviar registro', 'error');
      }

      btn.innerHTML = originalText;
      btn.disabled = false;
      isProcessing = false;
    }

    async function handleAddToQueue() {
      if (isProcessing) return;

      const formData = getFormData();
      if (!formData) {
        showToast('Preencha todos os campos corretamente', 'error');
        return;
      }

      isProcessing = true;
      const btn = document.getElementById('btn-add-queue');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<div class="spinner"></div> Adicionando...';
      btn.disabled = true;
      
      // formData já está com status 'Pendente' por padrão
      const newRecord = await addRecordToFirestore(formData);

      if (newRecord) {
        renderTable();
        updateSelectAllCheckbox();
        if (currentUser && currentUser.type === 'gestor') {
          updateManagerDashboard();
        }
        showToast('Adicionado ao resumo!', 'success');
        clearForm();
      } else {
        showToast('Erro ao adicionar registro', 'error');
      }

      btn.innerHTML = originalText;
      btn.disabled = false;
      isProcessing = false;
    }

    async function handleSendSelected() {
      // ... (esta função permanece a mesma, pois 'showResponsibleModal' é o próximo passo)
    }

    async function handleClearAll() {
      if (isProcessing) return;

      const userPendingRecords = allRecords.filter(r => 
        r.status === 'Pendente' && r.user_uid === currentUser.uid // Usar user_uid
      );
      
      if (userPendingRecords.length === 0) {
        showToast('Nenhum registro pendente para limpar', 'error');
        return;
      }

      isProcessing = true;
      const btn = document.getElementById('btn-clear-all');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<div class="spinner"></div> Limpando...';
      btn.disabled = true;

      // Deletar em lote do Firestore
      const batch = db.batch();
      userPendingRecords.forEach(record => {
        const docRef = db.collection("records").doc(record.id);
        batch.delete(docRef);
      });

      try {
        await batch.commit();

        // Atualizar array local
        allRecords = allRecords.filter(r => 
          !(r.status === 'Pendente' && r.user_uid === currentUser.uid)
        );
        
        renderTable();
        updateSelectAllCheckbox();
        
        if (currentUser && currentUser.type === 'gestor') {
          updateManagerDashboard();
        }

        showToast('Registros pendentes removidos!', 'success');
      } catch (error) {
        console.error("Erro ao limpar registros:", error);
        showToast('Erro ao limpar registros', 'error');
      }

      btn.innerHTML = originalText;
      btn.disabled = false;
      isProcessing = false;
    }

    function handleSelectAll(e) {
      let checkboxes = document.querySelectorAll('.record-checkbox');
      
      if (currentUser && currentUser.type !== 'gestor') {
        const userRecordIds = allRecords
          .filter(record => record.user_uid === currentUser.uid)
          .map(record => record.id);
        
        checkboxes = Array.from(checkboxes).filter(cb => 
          userRecordIds.includes(cb.dataset.id)
        );
      }
      
      checkboxes.forEach(cb => {
        if (!cb.disabled) {
          cb.checked = e.target.checked;
        }
      });
      updateSendButton();
    }

    function updateSelectAllCheckbox() {
      const selectAll = document.getElementById('select-all');
      
      let userCheckboxes = document.querySelectorAll('.record-checkbox:not(:disabled)');
      let userCheckedBoxes = document.querySelectorAll('.record-checkbox:checked:not(:disabled)');
      
      if (currentUser && currentUser.type !== 'gestor') {
        const userRecordIds = allRecords
          .filter(record => record.user_uid === currentUser.uid)
          .map(record => record.id);
        
        userCheckboxes = Array.from(userCheckboxes).filter(cb => 
          userRecordIds.includes(cb.dataset.id)
        );
        userCheckedBoxes = Array.from(userCheckedBoxes).filter(cb => 
          userRecordIds.includes(cb.dataset.id)
        );
      }
      
      if (userCheckboxes.length === 0) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
      } else if (userCheckedBoxes.length === userCheckboxes.length) {
        selectAll.checked = true;
        selectAll.indeterminate = false;
      } else if (userCheckedBoxes.length > 0) {
        selectAll.checked = false;
        selectAll.indeterminate = true;
      } else {
        selectAll.checked = false;
        selectAll.indeterminate = false;
      }
    }

    function updateSendButton() {
      let checkedBoxes = document.querySelectorAll('.record-checkbox:checked');
      
      if (currentUser && currentUser.type !== 'gestor') {
        const userRecordIds = allRecords
          .filter(record => record.user_uid === currentUser.uid)
          .map(record => record.id);
        
        checkedBoxes = Array.from(checkedBoxes).filter(cb => 
          userRecordIds.includes(cb.dataset.id)
        );
      }
      
      document.getElementById('btn-send-selected').disabled = checkedBoxes.length === 0;
      updateSelectAllCheckbox();
    }

    function renderTable() {
      const tbody = document.getElementById('records-tbody');
      
      // Na tela principal, mostramos apenas os registros do usuário logado
      let userRecords = allRecords.filter(record => record.user_uid === currentUser.uid);
      
      if (userRecords.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="10" class="empty-state">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
              </svg>
              <p>Nenhum registro na fila</p>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = userRecords.map(record => {
        const kmFinal = record.km_final !== null ? record.km_final.toFixed(1) + ' km' : '<em style="color: #9ca3af;">Aguardando...</em>';
        const distancia = (record.km_final !== null && record.km_final > record.km_inicial) ? (record.km_final - record.km_inicial).toFixed(1) + ' km' : '<em style="color: #9ca3af;">-</em>';
        const statusClass = `status-${record.status.toLowerCase()}`;
        const isDisabled = record.status !== 'Pendente';
        
        // CORREÇÃO DE DATA: Evita bugs de fuso horário
        let dataFormatada = 'Data Inválida';
        if (record.data) {
            const dateParts = record.data.split('-'); // [YYYY, MM, DD]
            if (dateParts.length === 3) {
              dataFormatada = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
            }
        }
        
        const responsavel = record.responsavel_unidade || '-';
        
        return `
          <tr>
            <td class="checkbox-cell">
              <input type="checkbox" 
                     class="record-checkbox" 
                     data-id="${record.id}"
                     ${isDisabled ? 'disabled' : ''}
                     onchange="updateSendButton()">
            </td>
            <td>${record.condutor}</td>
            <td>${record.placa}</td>
            <td>${dataFormatada}</td>
            <td>${record.destino}</td>
            <td>${record.km_inicial.toFixed(1)} km</td>
            <td>${kmFinal}</td>
            <td><strong>${distancia}</strong></td>
            <td><span class="status-badge ${statusClass}">${record.status}</span></td>
            <td><small>${responsavel}</small></td>
          </tr>
        `;
      }).join('');

      updateSendButton();
    }

    function showToast(message, type = 'success') {
      const existingToast = document.querySelector('.toast');
      if (existingToast) {
        existingToast.remove();
      }

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icon = type === 'success' 
        ? '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>'
        : '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/></svg>';
      
      toast.innerHTML = `${icon}<span>${message}</span>`;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    function showResponsibleModal(checkboxes) {
      const selectedRecords = [];
      let totalKm = 0;

      checkboxes.forEach(checkbox => {
        const recordId = checkbox.dataset.id;
        const record = allRecords.find(r => r.id === recordId);
        if (record && record.status === 'Pendente' && record.user_uid === currentUser.uid) {
          if (record.km_final !== null && record.km_final > record.km_inicial) {
            selectedRecords.push(record);
            totalKm += (record.km_final - record.km_inicial);
          } else {
            showToast(`Registro "${record.destino}" não pode ser enviado sem KM Final válido.`, 'error');
          }
        }
      });

      if (selectedRecords.length === 0) {
        showToast('Nenhum registro válido selecionado para envio', 'error');
        return;
      }

      document.getElementById('selected-count').textContent = selectedRecords.length;
      document.getElementById('selected-km').textContent = totalKm.toFixed(1) + ' km';
      document.getElementById('responsible-modal').classList.remove('hidden');
      
      window.selectedRecordsForSending = selectedRecords;
    }

    function hideResponsibleModal() {
      document.getElementById('responsible-modal').classList.add('hidden');
      document.getElementById('responsible-name').value = '';
      document.getElementById('unit-type').value = '';
      window.selectedRecordsForSending = null;
    }

    async function confirmResponsible() {
      const responsibleName = document.getElementById('responsible-name').value.trim();
      const unitType = document.getElementById('unit-type').value;

      if (!responsibleName || !unitType) {
        showToast('Preencha todos os campos obrigatórios', 'error');
        return;
      }

      if (!window.selectedRecordsForSending || window.selectedRecordsForSending.length === 0) {
        showToast('Nenhum registro selecionado', 'error');
        return;
      }

      isProcessing = true;
      const btn = document.getElementById('confirm-responsible-btn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<div class="spinner"></div> Enviando...';
      btn.disabled = true;

      let successCount = 0;
      const batch = db.batch(); // Usar lote do Firestore

      for (const record of window.selectedRecordsForSending) {
        const recordRef = db.collection("records").doc(record.id);
        batch.update(recordRef, {
          status: 'Enviado',
          responsavel_unidade: responsibleName,
          tipo_unidade: unitType
        });

        // Atualizar array local
        const index = allRecords.findIndex(r => r.id === record.id);
        if (index !== -1) {
          allRecords[index].status = 'Enviado';
          allRecords[index].responsavel_unidade = responsibleName;
          allRecords[index].tipo_unidade = unitType;
        }
        successCount++;
      }
      
      try {
        await batch.commit(); // Enviar lote para o Firebase
        
        renderTable();
        updateSelectAllCheckbox();
        
        if (currentUser && currentUser.type === 'gestor') {
          updateManagerDashboard();
        }

        if (successCount > 0) {
          showToast(`${successCount} registro(s) enviado(s) com atesto de ${responsibleName}!`, 'success');
        }
      } catch (error) {
          console.error("Erro ao enviar em lote:", error);
          showToast('Erro ao enviar registros. Tente novamente.', 'error');
      }

      btn.innerHTML = originalText;
      btn.disabled = false;
      isProcessing = false;
      
      hideResponsibleModal();
    }

    // --- FUNÇÕES DO DASHBOARD DO GESTOR ---
    
    function updateManagerDashboard() {
      console.log('🔄 Atualizando dashboard do gestor...');
      // 'allRecords' já foi carregado no login do gestor
      updateDashboardStats();
      updateRanking();
      renderManagerTable(allRecords); // Renderizar tabela completa inicialmente
      populateDriverFilter();
      updateBIAnalytics();
    }

    function updateDashboardStats() {
      const totalReports = allRecords.length;
      const sentReports = allRecords.filter(r => r.status === 'Enviado').length;
      const pendingReports = allRecords.filter(r => r.status === 'Pendente').length;
      
      const totalKm = allRecords.reduce((sum, r) => {
        if (r.km_final !== null && r.km_final !== undefined && !isNaN(r.km_final) && r.km_final > r.km_inicial) {
          return sum + (r.km_final - r.km_inicial);
        }
        return sum;
      }, 0);

      const activeDrivers = new Set(allRecords.map(r => r.condutor)).size;
      const validReports = allRecords.filter(r => r.km_final !== null && r.km_final !== undefined && r.km_final > r.km_inicial).length;
      const avgKmPerReport = validReports > 0 ? (totalKm / validReports) : 0;
      const efficiencyRate = totalReports > 0 ? ((sentReports / totalReports) * 100) : 0;
      
      const today = new Date().toISOString().split('T')[0];
      const reportsToday = allRecords.filter(r => r.data === today).length;

      document.getElementById('total-reports').textContent = totalReports;
      document.getElementById('sent-reports').textContent = sentReports;
      document.getElementById('pending-reports').textContent = pendingReports;
      document.getElementById('total-km').textContent = totalKm.toFixed(1) + ' km';
      document.getElementById('active-drivers').textContent = activeDrivers;
      document.getElementById('avg-km-per-report').textContent = avgKmPerReport.toFixed(1) + ' km';
      document.getElementById('efficiency-rate').textContent = efficiencyRate.toFixed(1) + '%';
      document.getElementById('reports-today').textContent = reportsToday;
    }

    function updateBIAnalytics() {
      // (Esta seção permanece a mesma, pois lê de 'allRecords')
      updatePerformanceMetrics();
      updateLocationAnalysis();
      generateActivityHeatmap();
      generateInsights();
      createCharts(); // Esta função chama as de desenhar gráfico
    }

    function updatePerformanceMetrics() {
      // (Esta função permanece a mesma)
       const driverStats = {};
      
      allRecords.forEach(record => {
        const driver = record.condutor;
        if (!driverStats[driver]) {
          driverStats[driver] = {
            name: driver,
            totalKm: 0,
            reportCount: 0,
            sentReports: 0
          };
        }
        
        if (record.km_final !== null && record.km_final > record.km_inicial) {
          driverStats[driver].totalKm += (record.km_final - record.km_inicial);
        }
        driverStats[driver].reportCount++;
        if (record.status === 'Enviado') {
          driverStats[driver].sentReports++;
        }
      });

      const drivers = Object.values(driverStats);
      const topPerformer = drivers.length > 0 ? 
        drivers.reduce((max, driver) => driver.totalKm > max.totalKm ? driver : max) : null;
      
      const avgReportsPerDriver = drivers.length > 0 ? 
        (allRecords.length / drivers.length) : 0;
      
      const completionRate = allRecords.length > 0 ? 
        ((allRecords.filter(r => r.status === 'Enviado').length / allRecords.length) * 100) : 0;

      const currentMonth = new Date().getMonth();
      const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
      const currentMonthReports = allRecords.filter(r => new Date(r.data).getMonth() === currentMonth).length;
      const lastMonthReports = allRecords.filter(r => new Date(r.data).getMonth() === lastMonth).length;
      
      const growthRate = lastMonthReports > 0 ? 
        (((currentMonthReports - lastMonthReports) / lastMonthReports) * 100) : 0;

      document.getElementById('top-performer').textContent = topPerformer ? topPerformer.name.split(' ')[0] : '-';
      document.getElementById('avg-reports-per-driver').textContent = avgReportsPerDriver.toFixed(1);
      document.getElementById('completion-rate').textContent = completionRate.toFixed(1) + '%';
      document.getElementById('growth-rate').textContent = (growthRate >= 0 ? '+' : '') + growthRate.toFixed(1) + '%';
    }

    function updateLocationAnalysis() {
      // (Esta função permanece a mesma)
      const locationStats = {};
      
      allRecords.forEach(record => {
        const location = record.user_location;
        if (!locationStats[location]) {
          locationStats[location] = {
            name: location,
            reports: 0,
            totalKm: 0,
            drivers: new Set()
          };
        }
        
        locationStats[location].reports++;
        locationStats[location].drivers.add(record.condutor);
        if (record.km_final !== null && record.km_final > record.km_inicial) {
          locationStats[location].totalKm += (record.km_final - record.km_inicial);
        }
      });

      const container = document.getElementById('location-analysis');
      const locations = Object.values(locationStats).sort((a, b) => b.reports - a.reports);

      if (locations.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #64748b;">Nenhum dado disponível</p>';
        return;
      }
      container.innerHTML = locations.map(location => `...`).join(''); // Omitido por brevidade
    }

    function generateActivityHeatmap() {
      // (Esta função permanece a mesma)
    }

    function generateInsights() {
      // (Esta função permanece a mesma)
    }

    function createCharts() {
      // (Esta função permanece a mesma)
      createTrendChart();
      createKMDistributionChart();
      createStatusPieChart();
    }

    function createTrendChart() {
      // (Esta função permanece a mesma)
    }

    function createKMDistributionChart() {
      // (Esta função permanece a mesma)
    }

    function createStatusPieChart() {
      // (Esta função permanece a mesma)
    }

    function drawLineChart(ctx, data) {
      // (Esta função permanece a mesma)
    }

    function drawBarChart(ctx, data) {
      // (Esta função permanece a mesma)
    }

    function drawPieChart(ctx, data) {
      // (Esta função permanece a mesma)
    }

    function updateRanking() {
      // (Esta função permanece a mesma)
    }

    function renderRanking(drivers, filterType) {
      // (Esta função permanece a mesma)
    }

    function filterManagerTable() {
      // (Esta função permanece a mesma)
    }

    function renderManagerTable(records) {
      const tbody = document.getElementById('manager-records-tbody');
      
      if (records.length === 0) {
        tbody.innerHTML = `...`; // Omitido
        return;
      }

      tbody.innerHTML = records.map(record => {
        const kmFinal = record.km_final !== null ? record.km_final.toFixed(1) + ' km' : '<em style="color: #9ca3af;">Aguardando...</em>';
        const distancia = (record.km_final !== null && record.km_final > record.km_inicial) ? (record.km_final - record.km_inicial).toFixed(1) + ' km' : '<em style="color: #9ca3af;">-</em>';
        const statusClass = `status-${record.status.toLowerCase()}`;
        
        // CORREÇÃO DE DATA
        let dataFormatada = 'Data Inválida';
        if (record.data) {
            const dateParts = record.data.split('-');
            if (dateParts.length === 3) {
              dataFormatada = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
            }
        }
        
        const responsavel = record.responsavel_unidade || '-';
        const tipoUnidade = record.tipo_unidade || '-';
        
        return `
          <tr>
            <td>${record.condutor}</td>
            <td>${record.placa}</td>
            <td>${dataFormatada}</td>
            <td>${record.destino}</td>
            <td>${record.km_inicial.toFixed(1)} km</td>
            <td>${kmFinal}</td>
            <td><strong>${distancia}</strong></td>
            <td><span class="status-badge ${statusClass}">${record.status}</span></td>
            <td>${record.user_location}</td>
            <td><small>${responsavel}</small></td>
            <td><small>${tipoUnidade}</small></td>
          </tr>
        `;
      }).join('');
    }

    function populateDriverFilter() {
      // (Esta função permanece a mesma)
    }

    // --- FUNÇÕES DE FOTO E EXPORTAÇÃO ATUALIZADAS ---
    
    function handlePhotoUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      // ... (validações de tipo e tamanho) ...

      if (file.size > 2 * 1024 * 1024) {
        showToast('A imagem deve ter no máximo 2MB', 'error');
        return;
      }

      // Referência do Firebase Storage
      const storageRef = storage.ref(`manager_photos/${currentUser.uid}/profile.jpg`);
      const uploadTask = storageRef.put(file);

      uploadTask.on('state_changed', 
        (snapshot) => {
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          showToast(`Enviando foto... ${Math.round(progress)}%`, 'success');
        }, 
        (error) => {
          console.error("Erro no upload: ", error);
          showToast("Erro ao enviar foto", "error");
        }, 
        () => {
          uploadTask.snapshot.ref.getDownloadURL().then(async (downloadURL) => {
            console.log('Arquivo disponível em', downloadURL);
            
            // Atualizar UI
            document.getElementById('manager-photo').innerHTML = `<img src="${downloadURL}" alt="Foto do Gestor" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
            
            // Salvar URL no perfil do usuário no Firestore
            try {
              await db.collection("users").doc(currentUser.uid).update({
                photoURL: downloadURL
              });
              currentUser.photoURL = downloadURL; // Atualiza objeto local
              showToast('Foto do perfil atualizada!', 'success');
            } catch (error) {
              console.error("Erro ao salvar URL da foto: ", error);
            }
          });
        }
      );
    }
    
    // As funções loadManagerPhoto() e DataStorage foram removidas/substituídas

    function applySearchFilters() {
      // (Esta função permanece a mesma)
    }

    function exportRanking() {
      // (Esta função permanece a mesma)
    }

    function exportToPDF() {
      // (Esta função permanece a mesma, mas verifique a formatação da data)
      // ... dentro do map ...
      // CORREÇÃO DE DATA
      let dataFormatada = 'Data Inválida';
      if (record.data) {
          const dateParts = record.data.split('-');
          if (dateParts.length === 3) {
            dataFormatada = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
          }
      }
      // ...
    }

    function exportToExcel() {
      // (Esta função permanece a mesma, mas verifique a formatação da data)
      // ... dentro do forEach ...
      // CORREÇÃO DE DATA
      let dataFormatada = 'Data Inválida';
      if (record.data) {
          const dateParts = record.data.split('-');
          if (dateParts.length === 3) {
            dataFormatada = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
          }
      }
      // ...
    }

    function getFilteredRecords() {
      // (Esta função permanece a mesma)
    }
    
    // Funções de Backup e Stats do DataStorage foram removidas
    // Seus botões agora podem mostrar um aviso:
    function showBackupModal() {
      showToast('Função de Backup via Firebase não implementada', 'error');
    }
    function showStorageStats() {
      showToast('Estatísticas agora são gerenciadas pelo Firebase', 'success');
    }

    // --- FUNÇÕES DE ANALYTICS AVANÇADO ---
    
    function filterAnalyticsByPeriod(period) {
      // (Esta função permanece a mesma)
    }

    function showPredictiveAnalysis() {
      // (Esta função permanece a mesma)
    }

    function calculatePredictions() {
      // (Esta função permanece a mesma)
    }

    function detectAnomalies() {
      // (Esta função permanece a mesma)
    }

    function showAnomaliesModal(anomalies) {
      // (Esta função permanece a mesma)
    }

    function getAnomalyTitle(type) {
      // (Esta função permanece a mesma)
    }

    function closePredictiveModal() {
      if (window.currentPredictiveModal) {
        window.currentPredictiveModal.remove();
        window.currentPredictiveModal = null;
      }
    }

    function closeAnomaliesModal() {
      if (window.currentAnomaliesModal) {
        window.currentAnomaliesModal.remove();
        window.currentAnomaliesModal = null;
      }
    }
    
    // Funções globais para os modais (removendo as de backup/stats)
    window.closePasswordModal = () => { /* Esta função não existe mais, pode remover */ };
    window.closePredictiveModal = closePredictiveModal;
    window.closeAnomaliesModal = closeAnomaliesModal;
    // ... (adicione outras funções globais se necessário)

    // Inicialização do sistema
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
    });

  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99da5349256b6d67',t:'MTc2Mjk5NTU1NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>